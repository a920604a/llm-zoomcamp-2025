ç•¶ç„¶å¯ä»¥ï¼æŠŠå…©å€‹å°ˆæ¡ˆçš„å„ªå‹¢çµåˆï¼Œèƒ½æ‰“é€ å‡ºæ›´å¼·å¤§ã€éˆæ´»ä¸”æ•ˆæœå„ªç•°çš„æ™ºèƒ½å•ç­”ç³»çµ±ã€‚ä»¥ä¸‹æ˜¯æˆ‘å¹«ä½ æ•´ç†çš„ã€Œå„ªå‹¢çµåˆæ–¹æ¡ˆã€èˆ‡å¯¦ä½œå»ºè­°ï¼š

---

# ğŸŒŸ çµåˆ Elasticsearch èˆ‡ FastEmbed + Qdrant çš„æ··åˆ RAG ç³»çµ±

---

## å…©å€‹å°ˆæ¡ˆå„ªå‹¢ç¸½çµ

| æ–¹æ¡ˆ                        | å„ªå‹¢èªªæ˜                                                                |
| ------------------------- | ------------------------------------------------------------------- |
| **å°ˆæ¡ˆä¸€ï¼ˆElasticsearchï¼‰**    | \* æˆç†Ÿç©©å®šçš„å…¨æ–‡ç´¢å¼•èˆ‡æœå°‹å¼•æ“<br>\* å¤šæ¬„ä½ã€å¸ƒæ—æ¢ä»¶ã€åŠ æ¬Šæœå°‹å½ˆæ€§é«˜<br>\* æ”¯æ´çµæ§‹åŒ–æŸ¥è©¢èˆ‡ç²¾ç¢ºåŒ¹é…         |
| **å°ˆæ¡ˆäºŒï¼ˆFastEmbed+Qdrantï¼‰** | \* å¼·å¤§çš„èªæ„å‘é‡æª¢ç´¢ï¼Œèƒ½æ•æ‰æ¨¡ç³Šæˆ–ç›¸ä¼¼èªæ„<br>\* æ”¯æ´å¤šç¨®åµŒå…¥æ¨¡å‹ï¼Œé©åˆå¤šèªè¨€èˆ‡éçµæ§‹åŒ–è³‡æ–™<br>\* å¿«é€Ÿé«˜ç¶­åº¦å‘é‡æœå°‹ |

---

## å–é•·è£œçŸ­ï¼šæ··åˆæ–¹æ¡ˆè¨­è¨ˆ

### 1. é›™éšæ®µæª¢ç´¢æµç¨‹ï¼ˆHybrid Retrievalï¼‰

* **ç¬¬ä¸€éšæ®µï¼šElasticsearch å¿«é€Ÿéæ¿¾**

  * åˆ©ç”¨é—œéµå­—ã€æ¬„ä½åŠ æ¬Šèˆ‡ç¯©é¸å¿«é€Ÿæ‰¾åˆ°ä¸€æ‰¹ã€Œå¤§è‡´ç›¸é—œã€çš„å€™é¸ FAQ æ–‡ä»¶ï¼ˆä¾‹å¦‚ Top 20ï¼‰ã€‚
  * ç¯©é¸æ¢ä»¶å¯ä»¥åŒ…å«æ™‚é–“ã€åˆ†é¡ã€ä½¿ç”¨è€…åå¥½ç­‰çµæ§‹åŒ–è³‡è¨Šã€‚

* **ç¬¬äºŒéšæ®µï¼šQdrant å‘é‡ç²¾é¸**

  * å°ç¬¬ä¸€éšæ®µå€™é¸æ–‡ä»¶ç”¨ FastEmbed åšå‘é‡åŒ–ã€‚
  * åˆ©ç”¨ Qdrant é€²è¡Œç²¾ç´°çš„èªæ„ç›¸ä¼¼åº¦æ’åºï¼Œé¸å‡ºçœŸæ­£æœ€è²¼è¿‘æŸ¥è©¢èªæ„çš„ Top Kã€‚
  * çµæœæ›´å…·èªæ„ç›¸é—œæ€§ï¼Œé¿å…é—œéµå­—è¡¨é¢ç›¸ä¼¼å»èªæ„ä¸ç¬¦çš„å•é¡Œã€‚

---

### 2. æ™ºèƒ½ Prompt çµ„åˆèˆ‡ LLM ç”Ÿæˆ

* æŠŠç¬¬äºŒéšæ®µæª¢ç´¢åˆ°çš„æœ€ç›¸é—œæ–‡ä»¶å…§å®¹çµ„æˆ Promptï¼Œä¸¦åŠ å…¥æ˜ç¢ºæŒ‡ä»¤è®“ LLM æ ¹æ“šä¸Šä¸‹æ–‡å›ç­”ã€‚

---

### 3. æ“´å……æ€§èˆ‡å½ˆæ€§

* æ”¯æ´å¤šèªè¨€èˆ‡å¤šç¨®åµŒå…¥æ¨¡å‹ï¼ˆä¾ç…§ç¡¬é«”è³‡æºèª¿æ•´ FastEmbed æ¨¡å‹ï¼‰ã€‚
* Elasticsearch ä¿ç•™çµæ§‹åŒ–è³‡æ–™ç´¢å¼•èƒ½åŠ›ï¼Œæ–¹ä¾¿ç®¡ç†èˆ‡å¾ŒçºŒçµ±è¨ˆåˆ†æã€‚
* Qdrant å¯æ­é…å¤šç¨®è·é›¢å‡½æ•¸ï¼ˆCosineã€Euclideanï¼‰èª¿æ•´æœå°‹ç²¾åº¦ã€‚

---

## æŠ€è¡“æ¶æ§‹ç¤ºæ„

```
ç”¨æˆ¶è¼¸å…¥å•é¡Œ
       â†“
[Elasticsearch] â€” ç”¨æ–‡å­—èˆ‡æ¬„ä½éæ¿¾ï¼Œå¿«é€Ÿæ‰¾åˆ°å€™é¸æ–‡ä»¶
       â†“
[FastEmbed] â€” æŠŠå€™é¸æ–‡ä»¶è½‰å‘é‡
       â†“
[Qdrant] â€” ç²¾ç´°å‘é‡ç›¸ä¼¼åº¦æ’åºï¼Œé¸å‡ºæœ€ç›¸ä¼¼æ–‡ä»¶
       â†“
[çµ„åˆ Prompt]
       â†“
[LLMï¼ˆOpenRouterï¼‰] â€” ç”¢ç”Ÿè‡ªç„¶ä¸”æœ‰æ ¹æ“šçš„å›ç­”
       â†“
è¼¸å‡ºç­”æ¡ˆçµ¦ä½¿ç”¨è€…
```

---

## å¯¦ä½œå»ºè­°é‡é»

* **è³‡æ–™åŒæ­¥**ï¼šå®šæœŸå°‡ FAQ ç­‰è³‡æ–™åŒæ­¥åˆ° Elasticsearch ä¸¦æº–å‚™å°æ‡‰å‘é‡ä¾› Qdrant ä½¿ç”¨ã€‚
* **è³‡æ–™å­˜å–æ•ˆç‡**ï¼šç”¨ Elasticsearch å¿«é€Ÿç¯©é¸æ¸›å°‘ Qdrant çš„è¨ˆç®—é‡ï¼Œæå‡æ•´é«”æŸ¥è©¢æ•ˆèƒ½ã€‚
* **éŒ¯èª¤å®¹å¿**ï¼šé›™ç³»çµ±å‚™æ´ï¼Œä¸€å€‹æœå°‹ä¸åˆ°æ™‚ç”¨å¦ä¸€å€‹è¼”åŠ©ã€‚
* **èª¿åƒå„ªåŒ–**ï¼šä¾æŸ¥è©¢èˆ‡å›ç­”å“è³ªï¼Œèª¿æ•´ Elasticsearch æ¬„ä½æ¬Šé‡å’Œ Qdrant å‘é‡æ¨¡å‹åƒæ•¸ã€‚

---

## çµè«–

é€™æ¨£çš„æ··åˆç³»çµ±èƒ½åŒæ™‚ç™¼æ®ï¼š

* **Elasticsearch** çš„çµæ§‹åŒ–èˆ‡é«˜æ•ˆé—œéµå­—æœå°‹å„ªå‹¢
* **FastEmbed + Qdrant** çš„èªæ„å‘é‡æœå°‹ç²¾åº¦èˆ‡éˆæ´»åº¦
* **LLM** çš„è‡ªç„¶èªè¨€ç”Ÿæˆèƒ½åŠ›

æ•´é«”å›ç­”æ›´ç²¾æº–ï¼Œç³»çµ±æ›´ç©©å®šï¼Œä½¿ç”¨è€…é«”é©—æ›´å¥½ã€‚

---
å¥½çš„ï¼ä»¥ä¸‹æ˜¯ä¸€å€‹ç°¡å–®çš„æ··åˆæª¢ç´¢ç³»çµ±éª¨æ¶ç¯„ä¾‹ï¼Œç¤ºç¯„å¦‚ä½•ç”¨ Python åŒæ™‚æ•´åˆ **Elasticsearch** åšåˆç¯©ï¼Œå†ç”¨ **FastEmbed + Qdrant** åšèªæ„ç²¾ç¯©ï¼Œæœ€å¾ŒæŠŠçµæœçµ„æˆ Prompt çµ¦ LLMï¼ˆé€™è£¡ç”¨å‡è¨­çš„ `call_llm` å‡½å¼ç¤ºç¯„ï¼‰ï¼š

---

```python
from elasticsearch import Elasticsearch
from fastembed import TextEmbedding
from qdrant_client import QdrantClient, models
import numpy as np

# === åˆå§‹åŒ–æœå‹™ ===
es = Elasticsearch("http://localhost:9200")
qdrant = QdrantClient("http://localhost:6333")

embed_model = TextEmbedding(model_name="jinaai/jina-embeddings-v2-small-en")

# Elasticsearch ç´¢å¼•åç¨±
ES_INDEX = "faq_index"
# Qdrant collection åç¨±
QDRANT_COLLECTION = "faq_vectors"

# === Step 1: Elasticsearch åˆç¯© ===
def elasticsearch_search(query, top_n=20):
    # é€™è£¡æ˜¯ç°¡å–®å¤šæ¬„ä½åŒ¹é…ï¼Œå¯èª¿æ•´ boost æ¬Šé‡
    body = {
        "size": top_n,
        "query": {
            "multi_match": {
                "query": query,
                "fields": ["question^3", "text", "section"]
            }
        }
    }
    res = es.search(index=ES_INDEX, body=body)
    hits = res['hits']['hits']
    # å›å‚³æ–‡ä»¶èˆ‡åŸå§‹å…§å®¹
    return [(hit['_id'], hit['_source']) for hit in hits]

# === Step 2: å°åˆç¯©çµæœåšå‘é‡åŒ–èˆ‡ Qdrant ç²¾ç¯© ===
def qdrant_semantic_rerank(query, candidates, top_k=5):
    # å°å€™é¸æ–‡æœ¬åšå‘é‡åŒ–ï¼ˆç”¨ question+textï¼‰
    candidate_texts = [c[1]['question'] + " " + c[1]['text'] for c in candidates]
    candidate_ids = [c[0] for c in candidates]

    # å»ºç«‹ Qdrant çš„å‘é‡æœå°‹æ¢ä»¶ï¼ˆç”¨æœ¬åœ° embedï¼ŒQdrant åªæ˜¯ç´¢å¼•ï¼‰
    vectors = list(embed_model.embed(candidate_texts))

    # Qdrant æŸ¥è©¢ (ä»¥ query ç”Ÿæˆå‘é‡ï¼Œå†æ¯”å° candidates å‘é‡)
    query_vector = list(embed_model.embed([query]))[0]

    # ç”¨ numpy è¨ˆç®—å‘é‡é»ç© sim (ç¤ºç¯„)
    similarities = [np.dot(query_vector, vec) for vec in vectors]

    # ä¾ç›¸ä¼¼åº¦æ’åºï¼Œå–å‰ top_k
    sorted_indices = np.argsort(similarities)[::-1][:top_k]

    reranked = [(candidate_ids[i], candidates[i][1], similarities[i]) for i in sorted_indices]
    return reranked

# === Step 3: çµ„åˆ Prompt çµ¦ LLM ===
def build_prompt(query, top_docs):
    prompt = "ä½ æ˜¯ä¸€å€‹æ™ºæ…§å•ç­”åŠ©ç†ï¼Œè«‹æ ¹æ“šä»¥ä¸‹è³‡æ–™å›ç­”å•é¡Œï¼š\n\n"
    for i, (_, doc, score) in enumerate(top_docs):
        prompt += f"è³‡æ–™{i+1} (ç›¸ä¼¼åº¦ {score:.3f}):\nå•é¡Œ: {doc['question']}\nå›ç­”: {doc['text']}\n\n"
    prompt += f"ä½¿ç”¨è€…å•é¡Œ: {query}\nè«‹æ ¹æ“šä»¥ä¸Šè³‡æ–™ä½œç­”ï¼š"
    return prompt

# === Step 4: å‘¼å« LLMï¼ˆæ­¤è™•å‡è¨­æœ‰ä¸€å€‹å‘¼å«å‡½å¼ï¼‰===
def call_llm(prompt):
    # é€™é‚Šè«‹è‡ªè¡Œä¸²æ¥ä½ çš„ LLM APIï¼Œä¾‹å¦‚ OpenAIã€OpenRouter
    # ç¯„ä¾‹ï¼š
    # response = openai.ChatCompletion.create(...)
    # return response['choices'][0]['message']['content']
    return "é€™æ˜¯æ¨¡æ“¬å›ç­”ï¼Œè«‹æ ¹æ“š Prompt å‘¼å«çœŸå¯¦ LLMã€‚"

# === ä¸»æµç¨‹ ===
def hybrid_search_and_answer(query):
    # 1. ç”¨ Elasticsearch å…ˆæ‰¾
    es_results = elasticsearch_search(query)

    if not es_results:
        return "æŠ±æ­‰ï¼Œæ‰¾ä¸åˆ°ç›¸é—œè³‡æ–™ã€‚"

    # 2. ç”¨ Qdrant åšèªæ„ç²¾ç¯©
    reranked_docs = qdrant_semantic_rerank(query, es_results)

    # 3. çµ„ Prompt
    prompt = build_prompt(query, reranked_docs)

    # 4. å‘¼å« LLM
    answer = call_llm(prompt)
    return answer

# === æ¸¬è©¦ç”¨ç¯„ä¾‹ ===
if __name__ == "__main__":
    user_query = "æˆ‘é‚„å¯ä»¥ç¾åœ¨åŠ å…¥èª²ç¨‹å—ï¼Ÿ"
    answer = hybrid_search_and_answer(user_query)
    print("AI å›ç­”ï¼š")
    print(answer)
```

---

### é‡é»èªªæ˜

* **Elasticsearch**ï¼šå¿«é€Ÿä¾é—œéµå­—èˆ‡æ¬„ä½åŠ æ¬Šï¼Œæ‰¾å‡ºæœ€ç›¸é—œæ–‡ä»¶ Top 20ã€‚
* **FastEmbed + Qdrant**ï¼šç”¨ FastEmbed å°å€™é¸æ–‡ä»¶åšå‘é‡åŒ–ï¼Œç”¨å‘é‡ç›¸ä¼¼åº¦é‡æ–°æ’åºï¼ŒæŒ‘å‡ºæœ€èªæ„ç›¸è¿‘ Top 5ã€‚
* **Prompt Engineering**ï¼šç”¨æœ€ç›¸é—œæ–‡ä»¶å…§å®¹çµ„æˆ Promptï¼Œä¸¦å¼•å° LLM ç”¢ç”Ÿå›ç­”ã€‚
* **LLM**ï¼šå‘¼å«å¤–éƒ¨å¤§æ¨¡å‹ APIï¼ˆç¤ºç¯„ä»£ç¢¼éœ€è‡ªè¡Œå¯¦ä½œä¸²æ¥ï¼‰ã€‚

---

å¦‚æœä½ éœ€è¦æˆ‘å¹«ä½ å¯« **Elasticsearch å»ºç«‹ç´¢å¼•ç¯„ä¾‹**ã€**Qdrant å»ºç«‹å‘é‡åº«ä¸Šå‚³ç¯„ä¾‹**ï¼Œæˆ–æ˜¯ **ä¸²æ¥ OpenAI/OpenRouter LLM API** ç¯„ä¾‹ï¼Œä¹Ÿå¯ä»¥å‘Šè¨´æˆ‘ï¼
